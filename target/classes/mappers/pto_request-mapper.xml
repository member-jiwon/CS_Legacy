<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Pto_request">

  <!-- 전체 리스트 (페이징) -->
  <select id="selectAllFromTo" parameterType="map" resultType="map">
    SELECT *
    FROM (
      SELECT ROWNUM AS rnum, A.*
      FROM (
        SELECT 
          a.pto_seq,
          a.member_email,
          a.pto_content,
          a.pto_start_at,
          a.pto_end_at,
          a.pto_status,
          m.name AS member_name,
          m.dept_code,
          m.level_code
        FROM pto_request a
        JOIN member m ON a.member_email = m.email
        ORDER BY a.pto_seq DESC
      ) A
      WHERE ROWNUM &lt;= #{end}
    )
    WHERE rnum &gt;= #{start}
  </select>


  <!-- 필터 리스트 (상태 + 부서코드) -->
  <select id="selectByFilterFromTo" parameterType="map" resultType="map">
    SELECT *
    FROM (
      SELECT ROWNUM AS rnum, A.*
      FROM (
        SELECT 
          a.pto_seq,
          a.member_email,
          a.pto_content,
          a.pto_start_at,
          a.pto_end_at,
          a.pto_status,
          m.name AS member_name,
          m.dept_code,
          m.level_code
        FROM pto_request a
        JOIN member m ON a.member_email = m.email
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
          <if test="status != null and status != ''">
            AND a.pto_status = #{status}
          </if>
          <if test="deptCode != null and deptCode != ''">
            AND m.dept_code = #{deptCode}
          </if>
        </trim>
        ORDER BY a.pto_seq DESC
      ) A
      WHERE ROWNUM &lt;= #{end}
    )
    WHERE rnum &gt;= #{start}
  </select>


  <!-- 전체 개수 -->
  <select id="getCount" resultType="int">
    SELECT COUNT(*) FROM pto_request
  </select>


  <!-- 필터된 개수 -->
  <select id="getCountByFilter" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM pto_request a
    JOIN member m ON a.member_email = m.email
    <trim prefix="WHERE" prefixOverrides="AND |OR ">
      <if test="status != null and status != ''">
        AND a.pto_status = #{status}
      </if>
      <if test="deptCode != null and deptCode != ''">
        AND m.dept_code = #{deptCode}
      </if>
    </trim>
  </select>


  <!-- 상태 업데이트 -->
  <update id="updateStatus" parameterType="map">
    UPDATE pto_request
    SET pto_status = #{newStatus}
    WHERE pto_seq = #{targetseq}
  </update>


  <!-- 디테일 하나 가져오기 -->
  <select id="toDetailPtoRequest" resultType="com.kedu.pto_request.Pto_requestDTO">
  	select * from pto_request where pto_seq = #{pto_seq}
  </select>
</mapper>